# Modeling Host-Parasite Burdens Across Varying Parasite Spatial Aggregation, Parasite Density, and Host Recovery Rate

## Broad Overview

This github repository features code for an agent-based modeling approach to testing the influence of spatial aggregation of environmental parasites on parasite aggregation on hosts.

The key functions are found in the "parasite_sim_functions.R" script. They include:

1.  A function to generate binary landscape matrices of varying parasite density and parasite spatial aggregation (slow but precise).
2.  A function to move hosts across a landscape and acquire/lose parasites.
3.  A function that wraps around the second function above to run simulations of host movement on a list of landscapes generated by the first function above.

To run the model, first use the "sap_landscape_setup.qmd" document to generate a suite of landscapes for simulating upon. Then, use the "sap_simulate.qmd" document to run the simulation model on the suite of landscapes you generated. Finally, you can use the sap_figures.qmd" document to summarize and visualize the simulation results.

There are also two supplementary documents:

1.  "sap_nonspatial_supplement.qmd" compares simulation results from the "simulate" document to a non-spatial version of the model.
2.  "sap_timestep_supplement.qmd" runs simulation on a smaller subset of landscape matrices to observe trends in outcome variables across more timestep, to see when things stabilize (or don't).

The "old_misc_files" folder contains development files and scratch code.


## Detailed Description Generated by Github Copilot

This GitHub repository features code for an agent-based modeling approach to testing the influence of spatial aggregation of environmental parasites on parasite aggregation on hosts.

## Table of Contents
- [Overview](#overview)
- [Setup](#setup)
- [Key Functions](#key-functions)
- [Running the Model](#running-the-model)
- [Supplementary Documents](#supplementary-documents)
- [Development Files](#development-files)

## Overview

The repository contains code to simulate host-parasite interactions across landscapes with varying parasite spatial aggregation, density, and host recovery rates. The aim is to understand how these factors influence parasite burdens on hosts.

## Setup

To get started, clone the repository and ensure you have the required R packages installed. The primary scripts are written in R and Quarto Markdown.

### Required Libraries
- `tidyverse`
- `furrr`
- `ape`
- `som.nn`

Load the required libraries and source the main functions script:

```r
library(tidyverse)
library(furrr)
library(ape)
library(som.nn)
source("parasite_sim_functions.R")
```

## Key Functions

The key functions are found in the `parasite_sim_functions.R` script. They include:

1. **Landscape Percolation Function**: Generates binary landscape matrices of varying parasite density and spatial aggregation.
2. **Host Movement Function**: Simulates host movement across a landscape and parasite acquisition/loss.
3. **Simulation Function**: Wraps around the host movement function to run simulations on landscapes generated by the percolation function.

### Landscape Percolation Function

```r
fast_ls_perc <- function(size, prop, cluster) {
  # Function to generate landscape matrices
  ...
}
```

### Host Movement Function

```r
move_host_fast <- function(hosts, coords, n_moves, n_reps, p_gain = "both", infec_prob = 0.5, recov_prob = 0) {
  # Function to move hosts and simulate parasite acquisition/loss
  ...
}
```

### Simulation Function

```r
parasite_sim <- function(landscape, n_hosts, n_moves, n_reps = 1, movetypes = tibble(type = 0.2, prop = 1), p_gain = "both", infec_prob = 0.5, recov_prob = 0) {
  # Function to run simulations on landscapes
  ...
}
```

## Running the Model

### Step 1: Generate Landscapes

Use the `sap_landscape_setup.qmd` document to generate a suite of landscapes for simulation.

```r
# Load required libraries and functions
library(tidyverse)
library(furrr)
library(ape)
library(som.nn)
source("parasite_sim_functions.R")

# Generate landscapes
props <- rep((1:9)/10, 16)
clusters <- rep(0:15, each = 9)
plan(multisession)
ls_list <- future_map2(props, clusters, ~fast_ls_perc(size = 48, prop = .x, cluster = .y), .options = furrr_options(seed = TRUE), .progress = TRUE)
```

### Step 2: Run Simulations

Use the `sap_simulate.qmd` document to run the simulation model on the generated landscapes.

```r
# Load required libraries and functions
library(tidyverse)
library(furrr)
library(ape)
library(som.nn)
source("parasite_sim_functions.R")

# Load landscapes
ls_list <- read_rds("sim_output/ls_list_20240719_091018.rds")

# Run simulations
recovs <- rep(c(0.05, 0.15, 0.25), 144)
ls_rep <- rep(ls_list, each = 3)
plan(multisession)
recov_sims <- future_map2(ls_rep, recovs, ~parasite_sim(landscape = .x, n_hosts = 96, n_moves = 100, n_reps = 10, recov_prob = .y), .options = furrr_options(seed = TRUE), .progress = TRUE)
```

### Step 3: Visualize Results

Use the `sap_figures.qmd` document to summarize and visualize the simulation results.

```r
# Load required libraries and data
library(tidyverse)
library(broom)
sim_data <- read_rds("sim_output/recov_sim_data20240719_092424.rds")
ls_list <- read_rds("sim_output/ls_list_20240719_091018.rds")

# Summarize and visualize results
sim_summary <- sim_data %>% group_by(prop, cluster, moran, rep_id, recov_prob) %>% summarize(...)
disp_fig <- ggplot(sim_summary, aes(...)) + geom_point() + ...
```

## Supplementary Documents

1. **sap_nonspatial_supplement.qmd**: Compares simulation results to a non-spatial version of the model.
2. **sap_timestep_supplement.qmd**: Runs simulations on a subset of landscape matrices to observe trends over more timesteps.

### Non-Spatial Model Comparison

```r
# Load required library
library(tidyverse)

# Define non-spatial model function
nonspatial_parasite_sim <- function(prop, n_hosts = 96, n_times = 100, infec_prob = 0.5, recov_prob, n_reps) {
  ...
}

# Run non-spatial simulations
densities <- rep((1:9)/10, 3)
recovs <- rep(c(0.05, 0.15, 0.25), each = 9)
ns_sim_output <- map2(densities, recovs, ~nonspatial_parasite_sim(prop = .x, recov_prob = .y, n_reps = 10)) %>% bind_rows()
```

### Extended Timesteps Simulation

```r
# Load required libraries and data
library(tidyverse)
library(furrr)
library(ape)
library(som.nn)
library(broom)
source("parasite_sim_functions.R")

# Load and filter landscapes
ls_list <- read_rds("sim_output/ls_list_20240719_091018.rds")
ls_subset <- map(ls_list, ~if (.x$ls_stats$cluster %in% c(0, 5, 10, 15) & .x$ls_stats$prop %in% c(0.1, 0.5, 0.9)) .x else NULL) %>% compact()

# Simulate for more timesteps
recovs <- rep(c(0.05, 0.15, 0.25), 12)
ls_rep <- rep(ls_subset, each = 3)
plan(multisession)
long_sims <- future_map2(ls_rep, recovs, ~parasite_sim(landscape = .x, n_hosts = 96, n_moves = 1000, n_reps = 10, recov_prob = .y), .options = furrr_options(seed = TRUE), .progress = TRUE)
```

## Development Files

The `old_misc_files` folder contains development files and scratch code.

## Contact

For any questions or issues, please open an issue on the repository or contact the author.

---
